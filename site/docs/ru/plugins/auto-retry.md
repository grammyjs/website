---
prev: false
next: false
---

# Повторные запросы к API (`auto-retry`)

Плагин auto-retry --- это все, что нужно для борьбы с [ограниениями флуда](../advanced/flood), то есть ошибками с кодом 429.
Его можно использовать для каждого бота во время обычной работы, но он особенно пригодится во время [трансляции сообщений](../advanced/flood#как-транслировать-сообщения).

Этот плагин представляет собой [трансформирующую функцию API](../advanced/transformers), что означает, что он позволяет перехватывать и изменять исходящие HTTP-запросы на лету.
Конкретнее, этот плагин автоматически определяет, если API-запрос не выполняется со значением `retry_after`, т.е. из-за ограничения скорости.
Он перехватит ошибку, подождет указанный период времени, а затем повторит запрос.

В дополнение к обработке ограничения скорости, этот плагин повторит запрос, если он завершился с внутренней ошибкой сервера, т.е. ошибкой с кодом 500 или больше.
Сетевые ошибки (те, которые [выдают `HttpError`](../guide/errors#объект-httperror) в grammY) также будут вызывать повторную попытку.
Повторное выполнение таких запросов - более-менее единственно разумная стратегия обработки этих двух типов ошибок.
Поскольку ни одна из них не предоставляет значения `retry_after`, плагин использует экспоненциальный откат, начинающийся с 3 секунд и ограничивающийся одним часом.

## Установка

Вы можете установить этот плагин на объект `bot.api`:

::: code-group

```ts [TypeScript]
import { autoRetry } from "@grammyjs/auto-retry";

// Использование плагина.
bot.api.config.use(autoRetry());
```

```js [JavaScript]
const { autoRetry } = require("@grammyjs/auto-retry");

// Использование плагина.
bot.api.config.use(autoRetry());
```

```ts [Deno]
import { autoRetry } from "https://deno.land/x/grammy_auto_retry/mod.ts";

// Использование плагина.
bot.api.config.use(autoRetry());
```

:::

Если вы вызовете, например, `sendMessage` и столкнетесь с ограничением скорости, это будет выглядеть, как будто запрос выполняется необычно долго.
На самом деле, выпоняется несколько HTTP-запросов с соответствующими задержками между ними.

## Настройка

Вы можете передать объект options, указывающий максимальное количество повторных попыток (`maxRetryAttempts`) или порог максимального времени ожидания (`maxDelaySeconds`).

### Ограничение повторов

Как только максимальное количество повторных попыток будет исчерпано, последующие ошибки для того же запроса не будут повторены.
Вместо этого передается объект ошибки из Telegram, что фактически приводит к неудачному запросу с ошибкой [`GrammyError`](../guide/errors#объект-grammyerror).

Аналогично, если запрос когда-либо завершится с `retry_after` больше, чем указано в опции `maxDelaySeconds`, запрос завершится немедленно.

```ts
autoRetry({
  maxRetryAttempts: 1, // повторяйте запросы только один раз
  maxDelaySeconds: 5, // немедленно остановится, если приходится ждать больше 5 секунд
});
```

### Повторный запрос ошибок внутреннего сервера

Вы можете использовать `rethrowInternalServerErrors`, чтобы отказаться от обработки внутренних ошибок сервера, как описано [выше](#повторные-запросы-к-api-auto-retry).
Опять же, передается объект ошибки от Telegram, что фактически приводит к отказу запроса с [`GrammyError`](../guide/errors#объект-grammyerror).

```ts
autoRetry({
  rethrowInternalServerErrors: true, // не обрабатывать внутренние ошибки сервера
});
```

### Повторный запрос сетевых ошибок

Вы можете использовать `rethrowHttpErrors`, чтобы отказаться от обработки сетевых ошибок, как описано [выше](#повторные-запросы-к-api-auto-retry).
Если это включено, то брошенные экземпляры [`HttpError`](../guide/errors#объект-httperror) будут переданы, не выполнив запрос.

```ts
autoRetry({
  rethrowHttpErrors: true, // не обрабатывать сетевые ошибки
});
```

## Краткая информация о плагине

- Название: `auto-retry`
- [Исходник](https://github.com/grammyjs/auto-retry)
- [Ссылка](/ref/auto-retry/)
