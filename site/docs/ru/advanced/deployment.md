# Советы по развертыванию

Вот список вещей, которые следует помнить при размещении на хостинге большого бота.

> Вас также могут заинтересовать наши инструкции по размещению ботов.
> Просмотрите **Хостинг / Туториалы** в верхней части страницы, чтобы увидеть некоторых хостинг-провайдеров, которые уже имеют специальные руководства.

## Ошибки

1. [Установите обработчик ошибок с помощью `bot.catch` для long polling или в вашем серверном фреймворке для вебхуков.](../guide/errors)
2. Используйте `await` для всех `Promise` и установите **линтинг** с правилами, которые гарантируют, что вы никогда об этом не забудете.

## Отправка сообщений

1. Отправляйте файлы, передавая путь или `Buffer` вместо потока (`stream`), или по крайней мере убедитесь, что вы [знаете о возможных подводных камнях](./transformers#случаи-использования-трансформирующих-функции).
2. Используйте `bot.on("callback_query:data")` в качестве резервного обработчика для [реагирования на все `callback_query`](../plugins/keyboard#ответ-на-нажатие-по-встроеннои-клавиатуре).
3. Используйте [плагин `auto-retry`](../plugins/auto-retry) для автоматической обработки ошибок, вызванных превышением лимита количества запросов, и повторной отправки таких запросов.

## Масштабирование

Это зависит от типа развертывания.

### Long Polling

1. [Используйте плагин `runner`](../plugins/runner).
2. [Используйте `sequentialize` с той же функцией для получения ключа сессии, что и в плагине сессий](./scaling#параллельность-это-сложно).
3. Просмотрите параметры конфигурации `run` ([документация API](/ref/runner/run)) и убедитесь, что они соответствуют вашим потребностям, или даже рассмотрите возможность собрать собственный runner со своим [источником обновлений](/ref/runner/updatesource) и их [поглотителем (sink)](/ref/runner/updatesink).
   Главное, что нужно учитывать --- это максимальная нагрузка, которую вы хотите применить к вашему серверу, то есть сколько обновлений может быть обработано одновременно.
4. Подумайте о реализации [корректного завершения работы](./reliability#правильное-выключение), чтобы завершить обработку текущих обновлений прежде чем вы остановите бота, например, для его обновления.

### Вебхуки

1. Убедитесь, что вы не выполняете долговременные операции в middleware: например, передача больших файлов.
   [Это приводит к ошибкам таймаута](../guide/deployment-types#своевременное-завершение-запросов-вебхуков) для вебхуков и дублированию обработки обновлений, поскольку Telegram будет повторно отправлять неподтвержденные обновления.
   Вместо этого рассмотрите возможность использования очереди задач.
2. Ознакомьтесь с конфигурацией `webhookCallback` ([документация API](/ref/core/webhookcallback)).
3. Если вы изменяли параметр `getSessionKey` для плагина сессий, [используйте `sequentialize` с той же функцией для получения ключа сессии, что и в плагине сессий](./scaling#параллельность-это-сложно).
4. Если вы работаете на бессерверной платформе или платформе с автоматическим масштабированием, [установите информацию о боте](/ref/core/botconfig), чтобы предотвратить чрезмерное количество вызовов `getMe`.
5. Подумайте об использовании [ответов вебхука](../guide/deployment-types#ответ-вебхука).

## Сессии

1. Подумайте об использовании `lazySessions`, как описано [здесь](../plugins/session#ленивые-сессии).
2. Используйте опцию `storage` для настройки вашего адаптера хранения данных, иначе все данные будут потеряны, когда процесс бота остановится.

## Тестирование

Пишите тесты для своего бота.
Это можно сделать с помощью grammY следующим образом:

1. Имитируйте исходящие запросы API с помощью [трансформирующих функций](./transformers).
2. Определите и отправьте образцы объектов обновления вашему боту с помощью `bot.handleUpdate` ([документация API](/ref/core/bot#handleupdate)).
   Воспользуйтесь этими [объектами обновления](https://core.telegram.org/bots/webhooks#testing-your-bot-with-updates), предоставленными командой Telegram, для вдохновения.

::: tip Предложите собственный плагин для тестирования
Хотя grammY предоставляет необходимые хуки для начала написания тестов, было бы очень полезно иметь плагин для тестирования ботов.
Это новая территория, т. к. таких плагинов для тестирования практически не существует.
Мы с нетерпением ждем вашего вклада!

Пример того, как можно провести тестирование, [можно найти здесь](https://github.com/PavelPolyakov/grammy-with-tests).
:::
