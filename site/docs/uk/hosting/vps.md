# Хостинг: VPS

Віртуальний приватний сервер, відомий переважно як VPS, є віртуальною машиною, яка працює в хмарі, а користувачі мають повний контроль над її системою.

Загалом у цьому посібнику ви дізнаєтеся наступне:

1. **Оренда сервера та домену**.
   У якості хостера буде використаний [Hostinger](https://hostinger.com.ua/).
   > Зауважте, що сервер вам потрібний обовʼязково, а домен лише якщо розгортаєте бота на вебхуках.
   > У цьому посібнику описано обидва варіанти.
2. **Встановлення та налаштування панелі керування**.
   У цьому посібнику буде використана [Fastpanel](https://fastpanel.direct/).
3. **Безпекові питання.**
4. **Написання скриптів CI/CD для GitHub та GitLab.**
5. **Підтримка безперервної роботи бота.**

## Налаштування сервера

Для цього посібника ми обрали [Hostinger](https://hostinger.com.ua/).
На те є кілька причин:

1. Він мультиязичний, тож вам буде зручно й зрозуміло ним користуватися.
2. У нього дуже багата документація, яка ретельно покриває всі проблемні місця, з якими може стикнутися новачок.
3. Він пропонує потужні сервери за досить низькими цінами.

З хостером познайомилися - можемо починати працювати! :rocket:

### Оренда сервера (обовʼязково)

:::tip Аналог серверу
Якщо ви не можете або не хочете орендувати сервер, ви можете замінити його віртуальною машиною.
Для цього скористайтеся програмою на кшталт [VirtualBox](https://virtualbox.org/).
Створіть віртуальну машину з потрібним дистрибутивом Linux й користуйтеся нею, як справжнім сервером.
:::

Перейдіть до [каталогу тарифів VPS](https://hostinger.com.ua/vps-hosting/).
Ми скористаємося тарифом "VPS 1".
Нижче ви можете побачити порівняльну таблицу, в якій описані запропоновані серверні ресурси й ліміти.
Ресурсів "VPS 1" достатньо для ботів з невеликою аудиторією, а для нашого тестового бота тим паче.

Поверніться до картки "VPS 1" й натисніть кнопку "Додати".
Вас буде автоматично перенаправлено на сторінку оформлення замовлення, де ви також одразу зареєструєтеся у Hostinger.

:::warning Змініть строк оренди!
Типовий строк оренди - 2 роки, і коштує це величезних грошей.
Вам цього напевно не треба, тому для початку орендуйте сервер на місяць, що коштує значно дешевше.

У будь-якому разі Hostinger надає 30-денну гарантію повернення грошей.
:::

Після оплати ви зможете налаштувати свій сервер:

1. **Місцезнаходження.**
   Ми рекомендуємо обрати найближче до вас розташування.
2. **Тип сервера.**
   Оскільки ми встановлюватимемо сторонню панель керування, обираємо варіант "Чиста ОС".
3. **Операційна система.**
   Перелік підтримуваних Fastpanel операційних систем ви можете знайти [тут](https://fastpanel.direct/wiki/en/how-to-install-fastpanel).
   Ми скористаємося Ubuntu 22.04.
   Якщо ви обрали іншу систему, деякі кроки можуть відрізнятися, тому будьте пильними.
4. **Назва сервера.**
5. **Root-пароль.**
   Придумайте сильний пароль й бережіть його у надійному сховищі!
6. **SSH ключ.**
   Ми налаштуємо його пізніше, тому поки що пропустіть цей крок.

Готово! :tada:

### Оренда домену (лише для вебхуків)

Щоб звʼязати бота, який працює за допомогою вебхуків, із зовнішнім світом, потрібно придбати домен.

Перейдіть на [сторінку пошуку доменних імен](https://hostinger.com.ua/kupyty-domen).
У полі введення тексту введіть доменне імʼя виду `<назва>.<зона>`.
Наприклад, `example.com`.

Якщо бажаний домен вільний, натисніть кнопку "Додати" поряд із ним.
Вас буде автоматично перенаправлено на сторінку оформлення замовлення, де ви також одразу зареєструєтеся у Hostinger, якщо досі не зареєстровані.
Оплатіть домен.

#### Направлення домена на VPS

Перш ніж ваш домен зможе працювати з вашим VPS, вам потрібно направити домен на свій сервер.
Щоб це зробити, на [панелі керування Hostinger](https://hpanel.hostinger.com/) натисніть кнопку "Керувати" поряд із вашим доменом.
Далі перейдіть на сторінку керування записами DNS, натиснувши кнопку "DNS / Сервери імен" у меню зліва.

> Спершу дізнайтеся IP-адресу свого VPS.

У списку DNS записів знайдіть запис типу `A` з іменем `@`.
Відредагуйте цей запис, змінивши IP-адресу в полі "Вказує на" на IP-адресу вашого VPS, а TTL вкажіть 3600.

Далі знайдіть й видаліть запис типу `CNAME` з іменем `www`.
Замість нього створіть новий запис типу `A` з іменем `www`, який вказуватиме на IP-адресу вашого VPS, а TTL вкажіть 3600.

> У разі винекнення труднощів скористайтеся іншим способом, описаним у [базі знань](https://support.hostinger.com/uk/articles/1583227-%D1%8F%D0%BA-%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%B8%D1%82%D0%B8-%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD-%D0%BD%D0%B0-vps).

Готово! :tada:

## Налаштування Fastpanel

Маючи чисту ОС, досвідчені користувачі можуть налаштувати всі необхідні сервіси самостійно.
Проте для новачків це буде дуже важко.
Тож наш вибір - панель керування.

Для цього посібника ми обрали [Fastpanel](https://fastpanel.direct/).
На те є кілька причин:

1. Вона мультиязична, тож вам буде зручно й зрозуміло нею користуватися.
2. У неї досить багата документація.
   Що найголовніше - вона дуже детальна й до того ж ілюстрована.
3. Вона має дуже приємний на вигляд інтерфейс у порівнянні з іншими панелями.

> Для тривалого опитування ви можете обійстися й без панелі керування.
> Проте ми настійно рекомендуємо все ж таки встановити її.
> За допомогою Fastpanel ми зможемо налаштувати базу даних, створити нового користувача тощо.

### Встановлення

Спершу підключимося до VPS через SSH:

```sh
ssh root@<ip-адреса>
```

Замініть `<ip-адреса>` на IP-адресу вашого сервера.

Для підключення до сервера введіть свій root-пароль, який ви налаштували під час оренди VPS.

:::tip Зміна root-пароля
Ви можете змінити root-пароль на сторінці налаштування VPS.

Щоб це зробити, на [панелі керування Hostinger](https://hpanel.hostinger.com/) натисніть кнопку "Керувати" поряд із вашим VPS.
Далі перейдіть на сторінку налаштувань, натиснувши кнопку "Налаштування" у меню зліва.
У секції "Root-пароль" у полі введення тексту введіть новий пароль й натисніть кнопку "Оновити".
Зачекайте, доки зміни не будуть застосовані.
:::

Щоб встановити Fastpanel виконайте наступну команду:

```sh
wget http://repo.fastpanel.direct/install_fastpanel.sh -O - | bash -
```

Після встановлення Fastpanel ви отримаєте повідомлення з даними доступу:

```sh
Congratulations! FASTPANEL successfully installed and available now for you at https://<ip-адреса>:8888/ .
Login: fastuser
Password: <пароль>
```

де `<ip-адреса>` буде IP-адерсою вашого сервера, а `<пароль>` буде автозгенерованим паролем.

> При першому вході Fastpanel запитає ліцензію, для отримання якої введіть свою адресу електронної пошти.
> Ліцензійні дані будуть надіслані на цю електронну адресу.
> Ліцензія повністю безкоштовна й не має жодних лімітів.

:::tip Змініть автогенерований пароль!
Автогенеровані сильні паролі це звісно добре, але не дуже зручно й безпечно, тому змініть його на сторінці налаштувань користувача.

Щоб перейти туди, у правому верхньому куті натисність на кнопку з іменем користувача.
Перед вами зʼявиться невелике віконце, в якому натисніть на посилання "Управління акаунтом".

На сторінці управління акаунтом введіть автозгенерований пароль, двічі введіть свій новий пароль й натисніть кнопку "Зберегти".
Ми рекомендуємо не вводити root-пароль від серверу, а придумати новий!
:::

### Налаштування додатків та сервісів (необовʼязково)

Як і будь-яка панель керування сервером, Fastpanel автоматично встановлює купу додаткових програм.
Не всі з них нам потрібні для роботи бота, але місце на диску й оперативну памʼять вони займають.
Тож ми рекомендуємо налаштувати додатки та сервіси.

Після налаштування ми знизили використання оперативної памʼяті з ~250 МБ до ~85 МБ згідно Fastpanel або з ~920 МБ до ~750 МБ згідно Hostinger.

#### Налаштування додатків

Перейдіть на сторінку додатків.
Для цього у меню зліва розкрийте підменю "Налаштування" й натисність на посилання "Доатки".

У нашому випадку видалимо наступні додатки: `bind9`, `jpegoptim`, `optipng`, `roundcube`.
Щоб видалити додаток, натисніть на кнопку з іконкою смітника поряд із додатком.

> `bind9` - це пакет для створення локального DNS-сервера.
> Він корисний, якщо ви хочете редагувати записи DNS у Fastpanel, а не у Hostinger.
> Проте у нашому випадку повʼязати їх неможливо, тому він непотрібний.
> Дізнатися детальніше про це ви можете у базі знань Fastpanel [тут](https://fastpanel.direct/wiki/en/name-servers/) і [тут](https://fastpanel.direct/wiki/en/synchronization-with-external-dns-servers).

> `jpegoptim` й `optipng` - інтерфейси командного рядка (CLI) для оптимізації зображень.

> `roundcube` - це клієнт для роботи з електронною поштою.

Проте встановимо `postgresql14`, оскільки наш бот працює саме з цією базою даних.
Щоб встановити додаток, натисніть на кнопку з іконкою стрілки й жорстким диском.

#### Налаштування сервісів

Перейдіть на сторінку сервісів.
Для цього у меню зліва розкрийте підменю "Налаштування" й натисність на посилання "Сервіси".

У нашому випадку зупинемо наступні сервіси: `dovecot`, `exim`, `mysql`, `proftpd`.
Щоб зупинити сервіс, натисність на кнопку з іконкою двух вертикальних паралельних ліній у кружечку.
Також вимкнемо автозавантаження для них, натиснувши на радіокнопку у відповідній колонці.

> `dovecot` й `exim` - це сервіси, які потрібні для роботи додатку `roundcube`.

> `mysql` - це база даних
> У нашому випадку замість неї ми використовуємо PostgreSQL 14.

> `proftpd` - це сервіс для передачі файлів по протоколу FTP.
> FTP слід використовувати для завантаження на сервер статичних файлів сайтів.
> Проте ми скористаємося SSH, тому FTP нам непотрібний.

Після цих дій у всіх перерахованих сервісів має бути статус "Вимкнений".

## CI/CD

[CI/CD](https://about.gitlab.com/topics/ci-cd/) - це важлива складова сучасного процесу розробки програмного забезпечення.
Цей посібник охоплює майже весь [конвеєр CI/CD](https://about.gitlab.com/topics/ci-cd/cicd-pipeline/).

Ми зосередимося на написанні скриптів для GitHub та GitLab.
За поотреби ви з легкістю зможете адаптувати наведені нижче приклади для обраного вами сервісу для CI/CD, як-от Jenkins, Buddy тощо.

:::tip Встановіть self-hosted runner!
GitHub та GitLab безкоштовно пропонують певну кількість ресурсів для виконання ваших завдань.
Проте в ході налаштування конвеєру ви можете швидко витрати їх всі, через що вам доведеться платити гроші за додаткові ресурси, інакше завдання не виконуватимуться.
Щоб такого не сталося, рекомендуємо встановити на свій компʼютер self-hosted runner, щоб завдання виконувалися у вас на компʼютері.
Тоді ви позбавитеся лімітів й зможете запускати конвеєри будь-якої складності й потужності (майже).
:::

## Підтримка безперервної роботи бота
