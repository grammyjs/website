# Повтор запитів до API (`auto-retry`)

> Розгляньте можливість використання [плагіна `transformer-throttler`](./transformer-throttler.md) замість `auto-retry`.

Цей плагін є [функцією-перетворювачем API](../advanced/transformers.md), що означає, що він дозволяє перехоплювати і змінювати вихідні запити HTTP на льоту.
Зокрема, цей плагін автоматично виявляє, якщо запит API завершується невдало зі значенням `retry_after`, тобто через обмеження.
Він перехоплює помилку, чекає вказаний проміжок часу, а потім повторює запит.

::: warning Будьте обережні з сервером Bot API
Telegram щедро надає інформацію про те, скільки часу ваш бот повинен чекати на наступний запит.
Використання плагіна `auto-retry` дозволить вашому боту краще працювати під час сплесків навантаження, оскільки запити не будуть просто провалюватися через перевищення ліміту.
Однак **auto-retry не слід використовувати**, якщо ви хочете уникнути регулярного перевищення лімітів.
Якщо ви регулярно перевищуєте ліміт кількості запитів, Telegram може вжити таких заходів, як обмеження або блокування вашого бота.
:::

Ви можете встановити цей плагін на обʼєкт `bot.api` наступним чином:

<CodeGroup>
  <CodeGroupItem title="TypeScript" active>

```ts
import { autoRetry } from "@grammyjs/auto-retry";

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

</CodeGroupItem>
 <CodeGroupItem title="JavaScript">

```js
const { autoRetry } = require("@grammyjs/auto-retry");

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

</CodeGroupItem>
 <CodeGroupItem title="Deno">

```ts
import { autoRetry } from "https://esm.sh/@grammyjs/auto-retry";

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

</CodeGroupItem>
</CodeGroup>

Якщо ви зараз викличете, наприклад, `sendMessage` й зіткнетеся з обмеженням, це виглядатиме ніби запит просто надзвичайно довго виконується.
Насправді виконується декілька запитів HTTP з відповідними затримками між ними.

Ви можете передати обʼєкт параметрів, який визначає максимальну кількість спроб (`maxRetryAttempts`, за замовчуванням 3) або межу максимального часу очікування (`maxDelaySeconds`, за замовчуванням 1 година).

Як тільки максимальна кількість спроб буде вичерпана, наступні помилки для того самого запиту не будуть повторюватися.
Замість цього буде передано обʼєкт помилки від Telegram, що фактично означає невдалість запиту з супутньою помилкою [`GrammyError`](../guide/errors.md#обʼєкт-grammyerror).

Аналогічно, якщо запит коли-небудь зазнає невдачі з `retry_after` більшим, ніж вказано в параметрі `maxDelaySeconds`, запит буде негайно відхилено.

```ts
autoRetry({
  maxRetryAttempts: 1, // повторювати запити лише один раз
  maxDelaySeconds: 5, // негайно виходити з ладу, якщо доводиться чекати більше 5-ти секунд
});
```

Ви можете використовувати `retryOnInternalServerErrors`, щоб включити всі інші внутрішні помилки сервера Telegram (код стану >= 500) у наведену вище процедуру.
Ці помилки будуть негайно повторені, але вони також враховують параметр `maxRetryAttempts`.

## Загальні відомості про плагін

- Назва: `auto-retry`
- Джерело: <https://github.com/grammyjs/auto-retry>
- Довідка: <https://doc.deno.land/https://raw.githubusercontent.com/grammyjs/auto-retry/main/src/index.ts>
