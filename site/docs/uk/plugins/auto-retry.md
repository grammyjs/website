---
prev: false
next: false
---

# Повтор запитів до API (`auto-retry`)

> Розгляньте можливість використання [плагіна `transformer-throttler`](./transformer-throttler) замість `auto-retry`.

Цей плагін є [функцією-перетворювачем API](../advanced/transformers), що означає, що він дозволяє перехоплювати і змінювати вихідні запити HTTP на льоту.
Зокрема, цей плагін автоматично виявляє, якщо запит API завершується невдало зі значенням `retry_after`, тобто був обмеженний.
Він перехоплює помилку, чекає вказаний проміжок часу, а потім повторює запит.

:::tip Контролювання перевищення кількості запитів до API
Telegram повідомить вас, якщо ви надсилаєте повідомлення занадто швидко.
Це важливий захід для боротьби з перевищенням кількості запитів до API, оскільки він гарантує, що ваш бот не створює надмірного навантаження на Telegram.
Використання цього плагіна важливе, тому що Telegram може забанити вашого бота, якщо ви забудете враховувати помилку з кодом статусу 429.
:::

Ви можете встановити цей плагін на обʼєкт `bot.api` наступним чином:

::: code-group

```ts [TypeScript]
import { autoRetry } from "@grammyjs/auto-retry";

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

```js [JavaScript]
const { autoRetry } = require("@grammyjs/auto-retry");

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

```ts [Deno]
import { autoRetry } from "https://esm.sh/@grammyjs/auto-retry";

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

:::

Якщо ви зараз викличете, наприклад, `sendMessage` й зіткнетеся з обмеженням, це виглядатиме ніби запит просто надзвичайно довго виконується.
Насправді виконується декілька запитів HTTP з відповідними затримками між ними.

Ви можете передати обʼєкт параметрів, який визначає максимальну кількість спроб (`maxRetryAttempts`, початково 3) або межу максимального часу очікування (`maxDelaySeconds`, початково 1 година).

Як тільки максимальна кількість спроб буде вичерпана, наступні спроби надіслати цей запит більше не робитимуться.
Замість цього буде передано обʼєкт помилки від Telegram, що фактично означає невдалість запиту з супутньою помилкою [`GrammyError`](../guide/errors#обʼєкт-grammyerror).

Аналогічно, якщо запит коли-небудь зазнає невдачі з `retry_after` більшим, ніж вказано в параметрі `maxDelaySeconds`, запит відразу буде визначено як невдалий.

```ts
autoRetry({
  maxRetryAttempts: 1, // повторювати запити лише один раз
  maxDelaySeconds: 5, // запит визначається невдалим негайно, якщо доводиться чекати більше 5-ти секунд
});
```

Ви можете використовувати `retryOnInternalServerErrors`, щоб включити всі інші внутрішні помилки сервера Telegram (код стану >= 500) у наведену вище процедуру.
Ці помилки будуть негайно повторені, але вони також враховують параметр `maxRetryAttempts`.

## Загальні відомості про плагін

- Назва: `auto-retry`
- Джерело: <https://github.com/grammyjs/auto-retry>
- Довідка: <https://doc.deno.land/https://raw.githubusercontent.com/grammyjs/auto-retry/main/src/index.ts>
