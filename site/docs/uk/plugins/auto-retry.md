---
prev: false
next: false
---

# Повтор запитів до API (`auto-retry`)

Цей плагін --- це все, що вам потрібно для обробки [обмежень кількості запитів до API](../advanced/flood), тобто помилок з кодом 429.
Його можна використовувати для будь-якого бота під час звичайної роботи, але особливо корисним він буде під час [трансляції](../advanced/flood#як-транслювати-повідомлення).

Цей плагін є [функцією-перетворювачем API](../advanced/transformers), що означає, що він дозволяє перехоплювати і змінювати вихідні запити HTTP на льоту.
Зокрема, цей плагін автоматично виявляє, якщо запит API завершується невдало зі значенням `retry_after`, тобто був обмеженний.
Він перехоплює помилку, чекає вказаний проміжок часу, а потім повторює запит.

Окрім обробки лімітів перевищення кількості запитів, цей плагін повторно виконає запит, якщо він завершився через внутрішню помилку сервера, тобто помилкою з кодом 500 або більшим.
Мережеві помилки (ті, що [викидають `HttpError`](../guide/errors#обʼєкт-httperror) в grammY) також призведуть до повторної спроби.
Повторні спроби таких запитів є більш-менш єдиною розумною стратегією для роботи з цими двома типами помилок.
Оскільки жоден з них не надає значення `retry_after`, плагін використовує експоненціальний відступ, починаючи з 3-х секунд і обмежуючись однією годиною.

## Встановлення

Ви можете встановити цей плагін на обʼєкт `bot.api` наступним чином:

::: code-group

```ts [TypeScript]
import { autoRetry } from "@grammyjs/auto-retry";

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

```js [JavaScript]
const { autoRetry } = require("@grammyjs/auto-retry");

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

```ts [Deno]
import { autoRetry } from "https://deno.land/x/grammy_auto_retry/mod.ts";

// Використовуємо плагін.
bot.api.config.use(autoRetry());
```

:::

Якщо ви зараз викличете, наприклад, `sendMessage` й зіткнетеся з обмеженням, це виглядатиме ніби запит просто надзвичайно довго виконується.
Насправді виконується декілька запитів HTTP з відповідними затримками між ними.

## Конфігурація

Ви можете передати обʼєкт параметрів, який визначає максимальну кількість спроб (`maxRetryAttempts`) або межу максимального часу очікування (`maxDelaySeconds`).

Як тільки максимальна кількість спроб буде вичерпана, наступні спроби надіслати цей запит більше не робитимуться.
Замість цього буде передано обʼєкт помилки від Telegram, що фактично означає невдалість запиту з супутньою помилкою [`GrammyError`](../guide/errors#обʼєкт-grammyerror).

Аналогічно, якщо запит коли-небудь зазнає невдачі з `retry_after` більшим, ніж вказано в параметрі `maxDelaySeconds`, запит відразу буде визначено як невдалий.

```ts
autoRetry({
  maxRetryAttempts: 1, // повторювати запити лише один раз
  maxDelaySeconds: 5, // запит визначається невдалим негайно, якщо доводиться чекати більше 5-ти секунд
});
```

Ви можете використовувати `retryOnInternalServerErrors`, щоб включити всі інші внутрішні помилки сервера Telegram (код стану >= 500) у наведену вище процедуру.
Ці помилки будуть негайно повторені, але вони також враховують параметр `maxRetryAttempts`.

### Перекидання внутрішніх помилок сервера

Ви можете використовувати `rethrowInternalServerErrors`, щоб відмовитися від обробки внутрішніх помилок сервера, як описано [вище](#повтор-запитів-до-api-auto-retry).
Знову ж таки, обʼєкт помилки з Telegram буде передано далі, що фактично призведе до невдачі запиту з [`GrammyError`](../guide/errors#обʼєкт-grammyerror).

```ts
autoRetry({
  rethrowInternalServerErrors: true, // не обробляти внутрішні помилки сервера
});
```

### Перекидання мережевих помилок

Ви можете використовувати `rethrowHttpErrors`, щоб відмовитися від обробки мережевих помилок, як описано [вище](#повтор-запитів-до-api-auto-retry).
Якщо цей параметр увімкнено, екземпляри [`HttpError`](../guide/errors#обʼєкт-httperror) передаватимуться далі, якщо запит не вдасться виконати.

```ts
autoRetry({
  rethrowHttpErrors: true, // не обробляти мережеві помилки
});
```

## Загальні відомості про плагін

- Назва: `auto-retry`
- [Джерело](https://github.com/grammyjs/auto-retry)
- [Довідка](/ref/auto-retry/)
