---
prev: ./commands.md
next: ./errors.md
---

# Middleware

–û–±—Ä–æ–±–Ω–∏–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω—å, —è–∫—ñ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –≤ `bot.on()`, `bot.command()` —Ç–∞ —ñ–Ω—à–∏–º –º–µ—Ç–æ–¥–∞–º, –Ω–∞–∑–∏–≤–∞—é—Ç—å—Å—è _middleware_.
–•–æ—á–∞ –º–æ–∂–Ω–∞ —Å–∫–∞–∑–∞—Ç–∏, —â–æ –≤–æ–Ω–∏ –≤—ñ–¥—Å—Ç–µ–∂—É—é—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –Ω–∞–∑–≤–∞—Ç–∏ —ó—Ö "–æ–±—Ä–æ–±–Ω–∏–∫–∞–º–∏" ‚Äì —Ü–µ —Å–ø—Ä–æ—â–µ–Ω–Ω—è.

> –£ —Ü—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –ø–æ—è—Å–Ω—é—î—Ç—å—Å—è, —â–æ —Ç–∞–∫–µ middleware, –∞ —Å–∏—Å—Ç–µ–º–∞ grammY –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —è–∫ –ø—Ä–∏–∫–ª–∞–¥, —â–æ–± –ø—Ä–æ—ñ–ª—é—Å—Ç—Ä—É–≤–∞—Ç–∏, —è–∫ —ó—Ö –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏.
> –Ø–∫—â–æ –≤–∏ —à—É–∫–∞—î—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é –ø—Ä–æ —Ç–µ, —â–æ —Ä–æ–±–∏—Ç—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é middleware —É grammY –æ—Å–æ–±–ª–∏–≤–æ—é, –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ [—Å–ø—Ä–æ—â–µ–Ω–Ω—è middleware](../advanced/middleware.md) —É —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó.

## –°—Ç–µ–∫ middleware

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, –≤–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –±–æ—Ç–∞ —Ç–∞–∫:

```ts{8}
const bot = new Bot("<—Ç–æ–∫–µ–Ω>");

bot.use(session());

bot.command("start", (ctx) => ctx.reply("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–∏–π!"));
bot.command("help", (ctx) => ctx.reply("–î–æ–≤—ñ–¥–∫–∞"));

bot.on(":text", (ctx) => ctx.reply("–¢–µ–∫—Å—Ç!")); // (*)
bot.on(":photo", (ctx) => ctx.reply("–§–æ—Ç–æ!"));

bot.start();
```

–ö–æ–ª–∏ –Ω–∞–¥—ñ–π–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑—ñ –∑–≤–∏—á–∞–π–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–≤–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º, –±—É–¥—É—Ç—å –≤–∏–∫–æ–Ω–∞–Ω—ñ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥—ñ—ó:

1. –í–∏ –Ω–∞–¥—Å–∏–ª–∞—î—Ç–µ –±–æ—Ç—É "–ü—Ä–∏–≤—ñ—Ç!".
2. Middleware —Å–µ–∞–Ω—Å—É –æ—Ç—Ä–∏–º—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω—É—î —Å–≤–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó —Å–µ–∞–Ω—Å—É.
3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∏ `/start`, —è–∫–∞ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å—Å—è.
4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ–º–∞–Ω–¥–∏ `/help`, —è–∫–∞ –Ω–µ –º—ñ—Å—Ç–∏—Ç—å—Å—è.
5. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±—É–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ç–µ–∫—Å—Ç—É –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –∞–±–æ –¥–æ–ø–∏—Å—ñ –∫–∞–Ω–∞–ª—É, —è–∫–µ –±—É–¥–µ –Ω–∞—è–≤–Ω–∏–º.
6. –ù–∞ —Ä—è–¥–∫—É, –ø–æ–∑–Ω–∞—á–µ–Ω–æ–º—É `(*)`, –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–æ middleware, —è–∫–∏–π –æ–±—Ä–æ–±–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –≤—ñ–¥–ø–æ–≤—ñ–≤—à–∏ `"–¢–µ–∫—Å—Ç!"`.

–û–Ω–æ–≤–ª–µ–Ω–Ω—è **–Ω–µ** –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Ñ–æ—Ç–æ, –æ—Å–∫—ñ–ª—å–∫–∏ middleware –Ω–∞ —Ä—è–¥–∫—É `(*)` –≤–∂–µ –æ–±—Ä–æ–±–∏–≤ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.

–¢–æ–∂, —è–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?
–î–∞–≤–∞–π—Ç–µ –¥—ñ–∑–Ω–∞—î–º–æ—Å—è.

–ú–∏ –º–æ–∂–µ–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–∏–ø `Middleware` —É –¥–æ–≤—ñ–¥—Ü—ñ grammY [—Ç—É—Ç](https://deno.land/x/grammy/mod.ts?s=Middleware):

```ts
// –î–µ—è–∫—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç–∏–ø—É –ø—Ä–æ–ø—É—â–µ–Ω–æ –¥–ª—è —Å—Ç–∏—Å–ª–æ—Å—Ç—ñ.
type Middleware = MiddlewareFn | MiddlewareObj;
```

–ê–≥–∞!
Middleware –º–æ–∂–µ –±—É—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—î—é –∞–±–æ –æ–±‚Äô—î–∫—Ç–æ–º.
–ü–æ–∫–∏ —â–æ –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ –ª–∏—à–µ —Ñ—É–Ω–∫—Ü—ñ—ó (`(ctx) => { ... }`), —Ç–æ–º—É –¥–∞–≤–∞–π—Ç–µ –Ω–∞—Ä–∞–∑—ñ –ø—Ä–æ—ñ–≥–Ω–æ—Ä—É—î–º–æ –æ–±‚Äô—î–∫—Ç–∏ middleware —Ç–∞ –∑–∞–≥–ª–∏–±–∏–º–æ—Å—è –≤ —Ç–∏–ø `MiddlewareFn` ([–¥–æ–≤—ñ–¥–∫–∞](https://deno.land/x/grammy/mod.ts?s=MiddlewareFn)):

```ts
// –ó–Ω–æ–≤—É –ø—Ä–æ–ø—É—â–µ–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç–∏–ø—É.
type MiddlewareFn = (ctx: Context, next: NextFunction) => MaybePromise<unknown>;
// –¥–µ
type NextFunction = () => Promise<void>;
```

–û—Ç–∂–µ, middleware –ø—Ä–∏–π–º–∞—î –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏!
–ü–æ–∫–∏ —â–æ –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ –ª–∏—à–µ –æ–¥–∏–Ω: –æ–±‚Äô—î–∫—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É `ctx`.
–ú–∏ [–≤–∂–µ –∑–Ω–∞—î–º–æ](./context.md), —â–æ —Ç–∞–∫–µ `ctx`, –∞–ª–µ –º–∏ —Ç–∞–∫–æ–∂ –±–∞—á–∏–º–æ —Ñ—É–Ω–∫—Ü—ñ—é `next`.
–ó–∞–≥–∞–ª–æ–º, —â–æ–± –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —â–æ —Ç–∞–∫–µ `next`, –º–∏ –º–∞—î–º–æ —Ä–æ–∑–≥–ª—è–Ω—É—Ç–∏ –≤—Å—ñ middleware, —è–∫—ñ –≤–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç–µ –Ω–∞ —Å–≤—ñ–π –æ–±‚Äô—î–∫—Ç –±–æ—Ç–∞.

–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –≤—Å—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó middleware —è–∫ –∫—ñ–ª—å–∫–∞ —Ä—ñ–≤–Ω—ñ–≤, —è–∫—ñ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –æ–¥–∏–Ω –Ω–∞ –æ–¥–Ω–æ–º—É.
–ü–µ—Ä—à–∏–π middleware, —É –Ω–∞—à–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ —Ü–µ `session`, —î –Ω–∞–π–≤–∏—â–∏–º —Ä—ñ–≤–Ω–µ–º, —Ç–æ–º—É –≤—ñ–Ω –ø–µ—Ä—à–∏–º –æ—Ç—Ä–∏–º—É—î –∫–æ–∂–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –≤—ñ–Ω –º–æ–∂–µ –æ–±—Ä–æ–±–∏—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–±–æ –ø–µ—Ä–µ–¥–∞—Ç–∏ –π–æ–≥–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–≤–µ–Ω—å: –æ–±—Ä–æ–±–Ω–∏–∫—É –∫–æ–º–∞–Ω–¥–∏ `/start`.
–§—É–Ω–∫—Ü—ñ—è `next` –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –¥–ª—è –≤–∏–∫–ª–∏–∫—É –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ middleware, —è–∫–∏–π —á–∞—Å—Ç–æ –Ω–∞–∑–∏–≤–∞—é—Ç—å _–Ω–∏–∂–Ω—ñ–º middleware_.
–¶–µ —Ç–∞–∫–æ–∂ –æ–∑–Ω–∞—á–∞—î, —â–æ —è–∫—â–æ –≤–∏ –Ω–µ –≤–∏–∫–ª–∏—á–µ—Ç–µ `next` —É —Å–≤–æ—î–º—É middleware, —Ç–æ –Ω–∏–∂–Ω—ñ middleware –Ω–µ –±—É–¥—É—Ç—å –≤–∏–∫–ª–∏–∫–∞–Ω—ñ.

–¶–µ–π —Å—Ç–µ–∫ —Ñ—É–Ω–∫—Ü—ñ–π —î _—Å—Ç–µ–∫–æ–º middleware_.

```asciiart:no-line-numbers
(ctx, next) => ...    |
(ctx, next) => ...    |‚Äî‚Äî‚Äî‚Äî‚Äîmiddleware, –≤–∏—â—ñ –∑–∞ X
(ctx, next) => ...    |
(ctx, next) => ...       <‚Äî middleware X. –í–∏–∫–ª–∏–∫–∞—î–º–æ `next`, —â–æ–± –ø–µ—Ä–µ–¥–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ü°≥
(ctx, next) => ...    |
(ctx, next) => ...    |‚Äî‚Äî‚Äî‚Äî‚Äîmiddleware, –Ω–∏–∂—á—ñ –∑–∞ X
(ctx, next) => ...    |
```

–û–∑–∏—Ä–∞—é—á–∏—Å—å –Ω–∞ –Ω–∞—à –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø—Ä–∏–∫–ª–∞–¥, —Ç–µ–ø–µ—Ä –º–∏ –∑–Ω–∞—î–º–æ, —á–æ–º—É `bot.on(":photo")` –Ω—ñ–∫–æ–ª–∏ –Ω–∞–≤—ñ—Ç—å –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏–º–µ—Ç—å—Å—è: middleware –≤ `bot.on(":text", (ctx) => { ... } )` –≤–∂–µ –æ–±—Ä–æ–±–∏–≤ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, —Ç–æ–º—É –π –Ω–µ –≤–∏–∫–ª–∏–∫–∞–≤ `next`.
–§–∞–∫—Ç–∏—á–Ω–æ, –≤—ñ–Ω –Ω–∞–≤—ñ—Ç—å –Ω–µ –≤–∫–∞–∑–∞–≤ `next` —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä.
–í—ñ–Ω –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—ñ–≥–Ω–æ—Ä—É–≤–∞–≤ `next`, –æ—Ç–∂–µ, –Ω–µ –ø–µ—Ä–µ–¥–∞–≤—à–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–ª—ñ.

–î–∞–≤–∞–π—Ç–µ —Å–ø—Ä–æ–±—É—î–º–æ —â–æ—Å—å —ñ–Ω—à–µ –∑ –Ω–∞—à–∏–º–∏ –Ω–æ–≤–∏–º–∏ –∑–Ω–∞–Ω–Ω—è–º–∏!

```ts
const bot = new Bot("<—Ç–æ–∫–µ–Ω>");

bot.on(":text", (ctx) => ctx.reply("–¢–µ–∫—Å—Ç!"));
bot.command("start", (ctx) => ctx.reply("–ö–æ–º–∞–Ω–¥–∞!"));

bot.start();
```

–Ø–∫—â–æ –≤–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞, –Ω–∞–ø–∏—Å–∞–Ω–æ–≥–æ –Ω–∞–¥ —Ü–∏–º —Ä—è–¥–∫–æ–º, —Ç–∞ –Ω–∞–¥—ñ—à–ª–µ—Ç–µ `/start`, –≤–∏ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø–æ–±–∞—á–∏—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å `–ö–æ–º–∞–Ω–¥–∞!`.
–ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:

1. –í–∏ –Ω–∞–¥—Å–∏–ª–∞—î—Ç–µ `"/start"` –±–æ—Ç—É.
2. Middleware `":text"` –æ—Ç—Ä–∏–º—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–µ–∫—Å—Ç, —â–æ –≤–¥–∞—î—Ç—å—Å—è, –æ—Å–∫—ñ–ª—å–∫–∏ –∫–æ–º–∞–Ω–¥–∏ —î —Ç–µ–∫—Å—Ç–æ–≤–∏–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏.
   –û–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–µ–≥–∞–π–Ω–æ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –ø–µ—Ä—à–∏–º middleware, —ñ –≤–∞—à –±–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î `–¢–µ–∫—Å—Ç!`.

–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–æ –º—ñ—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `/start`!
–ü–æ—Ä—è–¥–æ–∫, —É —è–∫–æ–º—É –≤–∏ —Ä–µ—î—Å—Ç—Ä—É—î—Ç–µ middleware, –º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –≤–∏–∑–Ω–∞—á–∞—î –ø–æ—Ä—è–¥–æ–∫ —à–∞—Ä—ñ–≤ —É —Å—Ç–µ–∫—É middleware.
–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏—Ä—ñ—à–∏—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É, –ø–æ–º—ñ–Ω—è–≤—à–∏ –º—ñ—Å—Ü—è–º–∏ 3-–π —Ç–∞ 4-–π —Ä—è–¥–æ–∫.
–Ø–∫—â–æ –≤–∏ –≤–∏–∫–ª–∏—á–µ—Ç–µ `next` —É 3-—É —Ä—è–¥–∫—É, —Ç–æ –±—É–¥–µ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –¥–≤—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.

**–ú–µ—Ç–æ–¥ `bot.use()` –ø—Ä–æ—Å—Ç–æ —Ä–µ—î—Å—Ç—Ä—É—î middleware, —è–∫–∏–π –æ—Ç—Ä–∏–º—É—î –≤—Å—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.**
–û—Å—å —á–æ–º—É `session()` –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `bot.use()`: –º–∏ —Ö–æ—á–µ–º–æ, —â–æ–± –ø–ª–∞–≥—ñ–Ω –ø—Ä–∞—Ü—é–≤–∞–≤ –∑ —É—Å—ñ–º–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º–∏, –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –¥–∞–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω–Ω—è.

–ù–∞—è–≤–Ω—ñ—Å—Ç—å —Å—Ç–µ–∫—É middleware —î –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ –ø–æ—Ç—É–∂–Ω–æ—é –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—é –±—É–¥—å-—è–∫–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É, —ñ —Ü–µ–π —à–∞–±–ª–æ–Ω —à–∏—Ä–æ–∫–æ –ø–æ–ø—É–ª—è—Ä–Ω–∏–π –Ω–µ –ª–∏—à–µ –¥–ª—è –±–æ—Ç—ñ–≤ Telegram.

–î–∞–≤–∞–π—Ç–µ –Ω–∞–ø–∏—à–µ–º–æ –Ω–∞—à –≤–ª–∞—Å–Ω–∏–π —à–º–∞—Ç–æ—á–æ–∫ middleware, —â–æ–± –∫—Ä–∞—â–µ –ø—Ä–æ—ñ–ª—é—Å—Ç—Ä—É–≤–∞—Ç–∏, —è–∫ —Ü–µ –ø—Ä–∞—Ü—é—î.

## –ù–∞–ø–∏—Å–∞–Ω–Ω—è –≤–ª–∞—Å–Ω–æ–≥–æ middleware

–ú–∏ –ø—Ä–æ—ñ–ª—é—Å—Ç—Ä—É—î–º–æ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—é middleware, –Ω–∞–ø–∏—Å–∞–≤—à–∏ –ø—Ä–æ—Å—Ç—É —Ñ—É–Ω–∫—Ü—ñ—é middleware, —è–∫–∞ –º–æ–∂–µ –≤–∏–º—ñ—Ä—é–≤–∞—Ç–∏ —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤–∞—à–æ–≥–æ –±–æ—Ç–∞, —Ç–æ–±—Ç–æ —Å–∫—ñ–ª—å–∫–∏ —á–∞—Å—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∞—à–æ–º—É –±–æ—Ç—É, —â–æ–± –æ–±—Ä–æ–±–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.

–û—Å—å —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –Ω–∞—à–æ–≥–æ middleware.
–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ –π–æ–≥–æ –∑ —Ç–∏–ø–æ–º middleware, –Ω–∞–≤–µ–¥–µ–Ω–æ–≥–æ –≤–∏—â–µ, —ñ –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –º–∏ –¥—ñ–π—Å–Ω–æ –º–∞—î–º–æ middleware.

<CodeGroup>
  <CodeGroupItem title="TypeScript" active>

```ts
/** –í–∏–º—ñ—Ä—é—î–º–æ —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–æ—Ç–∞ —Ç–∞ –≤–∏–≤–æ–¥–∏–º–æ –π–æ–≥–æ —É `console` */
async function responseTime(
  ctx: Context,
  next: NextFunction, // —Ü–µ –ø—Å–µ–≤–¥–æ–Ω—ñ–º –¥–ª—è: () => Promise<void>
): Promise<void> {
  // TODO: —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏
}
```

</CodeGroupItem>
 <CodeGroupItem title="JavaScript">

```js
/** –í–∏–º—ñ—Ä—é—î–º–æ —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–æ—Ç–∞ —Ç–∞ –≤–∏–≤–æ–¥–∏–º–æ –π–æ–≥–æ —É `console` */
async function responseTime(ctx, next) {
  // TODO: —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏
}
```

</CodeGroupItem>
</CodeGroup>

–ú–∏ –º–æ–∂–µ–º–æ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –π–æ–≥–æ –≤ –æ–±'—î–∫—Ç `bot` –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `bot.use()`:

```ts
bot.use(responseTime);
```

–ü–æ—á–Ω–µ–º–æ –π–æ–≥–æ —Ä–µ–∞–ª—ñ–∑–æ–≤—É–≤–∞—Ç–∏.
–û—Å—å —â–æ –º–∏ —Ö–æ—á–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏:

1. –©–æ–π–Ω–æ –Ω–∞–¥—Ö–æ–¥–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –º–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ `Date.now()` —É –∑–º—ñ–Ω–Ω—ñ–π.
2. –ú–∏ –≤–∏–∫–ª–∏–∫–∞—î–º–æ –Ω–∏–∂–Ω—ñ middleware, –æ—Ç–∂–µ, –¥–æ–∑–≤–æ–ª—è—î–º–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤—Å—é –ø–æ–¥–∞–ª—å—à—É –æ–±—Ä–æ–±–∫—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.
   –¶–µ –≤–∫–ª—é—á–∞—î –ø—ñ–¥–±—ñ—Ä –∫–æ–º–∞–Ω–¥, –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–Ω–Ω—è —Ç–∞ –≤—Å–µ —ñ–Ω—à–µ, —â–æ —Ä–æ–±–∏—Ç—å –≤–∞—à –±–æ—Ç.
3. –ú–∏ –∑–Ω–æ–≤—É –±–µ—Ä–µ–º–æ `Date.now()`, –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ –π–æ–≥–æ –∑—ñ —Å—Ç–∞—Ä–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ `console.log` –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ü—ñ –≤ —á–∞—Å—ñ –≤ –∫–æ–Ω—Å–æ–ª—å.

–í–∞–∂–ª–∏–≤–æ _—Å–ø–æ—á–∞—Ç–∫—É_ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–∞—à middleware `responseTime` —É –±–æ—Ç–∞: –≤–µ—Ä—Ö–Ω—é —á–∞—Å—Ç–∏–Ω—É —Å—Ç–µ–∫—É middleware, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤–∫–ª—é—á–µ–Ω—ñ —É –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è.

<CodeGroup>
  <CodeGroupItem title="TypeScript" active>

```ts
/** –í–∏–º—ñ—Ä—é—î–º–æ —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–æ—Ç–∞ —Ç–∞ –≤–∏–≤–æ–¥–∏–º–æ –π–æ–≥–æ —É `console` */
async function responseTime(
  ctx: Context,
  next: NextFunction, // —Ü–µ –ø—Å–µ–≤–¥–æ–Ω—ñ–º –¥–ª—è: () => Promise<void>
): Promise<void> {
  // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
  const before = Date.now(); // –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥
  // –≤–∏–∫–ª–∏–∫–∞—î–º–æ –Ω–∏–∂–Ω—ñ middleware
  await next(); // –ø–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è, —â–æ –¥–æ—á–µ–∫–∞–ª–∏—Å—è (`await`)!
  // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
  const after = Date.now(); // –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥
  // –≤–∏–≤–æ–¥–∏–º–æ —Ä—ñ–∑–Ω–∏—Ü—é —É –∫–æ–Ω—Å–æ–ª—å
  console.log(`–ß–∞—Å –≤—ñ–¥–≥—É–∫—É: ${after - before} –º—Å`);
}

bot.use(responseTime);
```

</CodeGroupItem>
 <CodeGroupItem title="JavaScript">

```js
/** –í–∏–º—ñ—Ä—é—î–º–æ —á–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–æ—Ç–∞ —Ç–∞ –≤–∏–≤–æ–¥–∏–º–æ –π–æ–≥–æ —É `console` */
async function responseTime(ctx, next) {
  // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –¥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
  const before = Date.now(); // –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥
  // –≤–∏–∫–ª–∏–∫–∞—î–º–æ –Ω–∏–∂–Ω—ñ middleware
  await next(); // –ø–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—è, —â–æ –¥–æ—á–µ–∫–∞–ª–∏—Å—è (`await`)!
  // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
  const after = Date.now(); // –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥
  // –≤–∏–≤–æ–¥–∏–º–æ —Ä—ñ–∑–Ω–∏—Ü—é —É –∫–æ–Ω—Å–æ–ª—å
  console.log(`–ß–∞—Å –≤—ñ–¥–≥—É–∫—É: ${after - before} –º—Å`);
}

bot.use(responseTime);
```

</CodeGroupItem>
</CodeGroup>

–ì–æ—Ç–æ–≤–æ —Ç–∞ –ø—Ä–∞—Ü—é—î! :heavy_check_mark:

–ù–µ —Å–æ—Ä–æ–º—Ç–µ—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ–π middleware –¥–ª—è —Å–≤–æ–≥–æ –æ–±‚Äô—î–∫—Ç–∞ –±–æ—Ç–∞, –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ –±—ñ–ª—å—à–µ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ —ñ –ø–æ–≥—Ä–∞–π—Ç–µ—Å—è –∑ –ø—Ä–∏–∫–ª–∞–¥–æ–º.
–¶–µ –¥–æ–ø–æ–º–æ–∂–µ –≤–∞–º –ø–æ–≤–Ω—ñ—Å—Ç—é –∑—Ä–æ–∑—É–º—ñ—Ç–∏, —â–æ —Ç–∞–∫–µ middleware.

::: danger –ó–ê–°–¢–ï–†–ï–ñ–ï–ù–ù–Ø: –∑–∞–≤–∂–¥–∏ —á–µ–∫–∞–π—Ç–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ middleware!
–Ø–∫—â–æ –≤–∏ –∫–æ–ª–∏-–Ω–µ–±—É–¥—å –≤–∏–∫–ª–∏—á–µ—Ç–µ `next()` –±–µ–∑ –∫–ª—é—á–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞ `await`, –¥–µ—â–æ –≤–∏–π–¥–µ –∑ –ª–∞–¥—É:

- :x: –í–∞—à —Å—Ç–µ–∫ middleware –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–æ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É.
- :x: –í–∏ –º–æ–∂–µ—Ç–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ –¥–∞–Ω—ñ.
- :x: –î–µ—è–∫—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–æ–∂—É—Ç—å –Ω–µ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏—Å—è.
- :x: –í–∞—à –±–æ—Ç –º–æ–∂–µ –≤–∏–ø–∞–¥–∫–æ–≤–æ –∞–≤–∞—Ä—ñ–π–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–æ–±–æ—Ç—É —É —Å–ø–æ—Å—ñ–±, —è–∫–∏–π –≤–∞–∂–∫–æ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏.
- :x: –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞, –≤–∞—à –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫ –Ω–µ –±—É–¥–µ –≤–∏–∫–ª–∏–∫–∞–Ω–∏–π.
  –ù–∞—Ç–æ–º—ñ—Å—Ç—å –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ, —â–æ –∑‚Äô—è–≤–∏—Ç—å—Å—è `UnhandledPromiseRejectionWarning`, —â–æ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –∑–±–æ—é –≤–∞—à–æ–≥–æ –±–æ—Ç–∞.
- :x: –ú–µ—Ö–∞–Ω—ñ–∑–º –ø—Ä–æ—Ç–∏–¥—ñ—ó [–ø–ª–∞–≥—ñ–Ω—É –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—ñ](../plugins/runner.md) –ª–∞–º–∞—î—Ç—å—Å—è, —â–æ –∑–∞—Ö–∏—â–∞—î –≤–∞—à —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥ –Ω–∞–¥–º—ñ—Ä–Ω–æ –≤–∏—Å–æ–∫–æ–≥–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ–¥ —á–∞—Å —Å—Ç—Ä–∏–±–∫—ñ–≤ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.
- :skull: –Ü–Ω–æ–¥—ñ —Ü–µ —Ç–∞–∫–æ–∂ –º–æ–∂–µ –≤–±–∏—Ç–∏ –≤—Å—ñ—Ö –≤–∞—à–∏—Ö –Ω–µ–≤–∏–Ω–Ω–∏—Ö –∫–æ—Ç–∏–∫—ñ–≤. :crying_cat_face:

:::

–ü—Ä–∞–≤–∏–ª–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `await` —î –æ—Å–æ–±–ª–∏–≤–æ –≤–∞–∂–ª–∏–≤–∏–º –¥–ª—è `next()`, –∞–ª–µ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –≤–æ–Ω–æ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –±—É–¥—å-—è–∫–æ–≥–æ –≤–∏—Ä–∞–∑—É, —è–∫–∏–π –ø–æ–≤–µ—Ä—Ç–∞—î `Promise`.
–¶–µ –≤–∫–ª—é—á–∞—î `bot.api.sendMessage`, `ctx.reply` —Ç–∞ –≤—Å—ñ —ñ–Ω—à—ñ –º–µ—Ä–µ–∂–µ–≤—ñ –≤–∏–∫–ª–∏–∫–∏.
–Ø–∫—â–æ –≤–∞—à –ø—Ä–æ—î–∫—Ç –≤–∞–∂–ª–∏–≤–∏–π –¥–ª—è –≤–∞—Å, –≤–∏ –Ω–∞–ø–µ–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –ª—ñ–Ω—Ç–∏–Ω–≥—É, —è–∫—ñ –ø–æ–ø–µ—Ä–µ–¥–∂–∞—é—Ç—å –≤–∞—Å, —è–∫—â–æ –≤–∏ –∑–∞–±—É–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `await` –Ω–∞ `Promise`.

::: tip –£–≤—ñ–º–∫–Ω—ñ—Ç—å no-floating-promises
–†–æ–∑–≥–ª—è–Ω—å—Ç–µ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è [ESLint](https://eslint.org/) —ñ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ –π–æ–≥–æ –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è [no-floating-promises](https://github.com/typescript-eslint/typescript-eslint/blob/master/packages/eslint-plugin/docs/rules/no-floating-promises.md).
–¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –≤–∏ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞–±—É–¥–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `await`, –∞–¥–∂–µ ESLint –∫—Ä–∏–∫–Ω–µ –Ω–∞ –≤–∞—Å.
:::

## –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ middleware —É grammY

–£ grammY middleware –º–æ–∂–µ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ `Promise`, —è–∫–æ–≥–æ —Å–ª—ñ–¥ –¥–æ—á–µ–∫–∞—Ç–∏—Å—è (`await`), –∞–ª–µ –≤—ñ–Ω —Ç–∞–∫–æ–∂ –º–æ–∂–µ –±—É—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–º.

–ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —ñ–Ω—à–∏—Ö —Å–∏—Å—Ç–µ–º middleware, —Ç–∞–∫–∏—Ö —è–∫ —Å–∏—Å—Ç–µ–º–∞ `express`, –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ —É `next`.
`next` –Ω–µ –ø—Ä–∏–π–º–∞—î –∂–æ–¥–Ω–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤.
–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É, –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –∫–∏–Ω—É—Ç–∏ (`throw`) —ó—ó.
–©–µ –æ–¥–Ω–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ –Ω–µ –º–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è, —Å–∫—ñ–ª—å–∫–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –ø—Ä–∏–π–º–∞—î –≤–∞—à middleware: `() => {}` –±—É–¥–µ –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è —Ç–æ—á–Ω–æ —è–∫ `(ctx) => {}` –∞–±–æ —è–∫ `(ctx, next) => {}`.

–Ü—Å–Ω—É—î –¥–≤–∞ —Ç–∏–ø–∏ middleware: —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –æ–±‚Äô—î–∫—Ç–∏.
–û–±‚Äô—î–∫—Ç–∏ middleware —î –ø—Ä–æ—Å—Ç–æ –æ–±–æ–ª–æ–Ω–∫–æ—é –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ–π middleware.
–ó–¥–µ–±—ñ–ª—å—à–æ–≥–æ –≤–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ, –∞–ª–µ —ñ–Ω–æ–¥—ñ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ–º –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞–º –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è —É —Å–∫–ª–∞–¥–Ω–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö: –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —ñ–∑ [Composer](https://deno.land/x/grammy/mod.ts?s=Composer):

```ts
const bot = new Bot("<—Ç–æ–∫–µ–Ω>");

bot.use(/*...*/);
bot.use(/*...*/);

const composer = new Composer();
composer.use(/*...*/);
composer.use(/*...*/);
composer.use(/*...*/);
bot.use(composer); // composer ‚Äî –æ–±‚Äô—î–∫—Ç middleware!

bot.use(/*...*/);
bot.use(/*...*/);
// ...
```

–Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –≥–ª–∏–±—à–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫ grammY —Ä–µ–∞–ª—ñ–∑—É—î middleware, –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ [—Å–ø—Ä–æ—â–µ–Ω–Ω—è middleware](../advanced/middleware.md) —É —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó.
