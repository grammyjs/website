---
prev: ./middleware.md
next: ./inline-queries.md
---

# Обробка помилок

Кожна окрема помилка, спричинена вашим middleware, буде виявлена grammY.
Ви повинні встановити спеціальний обробник помилок для обробки помилок.

Найголовніше, цей розділ навчить вас, [як перехоплювати помилки](#перехоплення-помилок), які можуть виникати.

Після цього ми розглянемо всі три типи помилок, з якими може зіткнутися ваш бот.

| Назва                                | Значення                                                                                                |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------- |
| [`BotError`](#обʼєкт-boterror)       | Об’єкт Error, який огортає будь-яку помилку, створену вашим middleware: наприклад, наступні дві помилки |
| [`GrammyError`](#обʼєкт-grammyerror) | Викидається, якщо сервер Bot API повертає `ok: false`; отже, ваш запит API був недійсним і не вдався    |
| [`HttpError`](#обʼєкт-httperror)     | Викидається, якщо сервер Bot API не доступний                                                           |

Досконаліший механізм обробки помилок можна знайти [тут](#межі-помилок).

## Перехоплення помилок

Спосіб перехоплення помилок залежатиме від ваших налаштувань.

### Тривале опитування

Якщо ви запускаєте свого бота через `bot.start()` або використовуєте [плагін для конкурентності (runner)](../plugins/runner.md), то вам треба **встановити обробник помилок через `bot.catch`**.

За замовчуванням у grammY вже встановлений обробник помилок, який зупиняє бота, якщо він запущений через `bot.start()`.
Потім він повторно викидає помилку.
Що буде далі, залежить від платформи.
Ось чому **ви повинні встановити обробник помилок через `bot.catch`**.

Наприклад:

```ts
bot.catch((err) => {
  const ctx = err.ctx;
  console.error(`Помилка під час обробки оновлення ${ctx.update.update_id}:`);
  const e = err.error;
  if (e instanceof GrammyError) {
    console.error("Помилка в запиті:", e.description);
  } else if (e instanceof HttpError) {
    console.error("Не вдалося зв'язатися з Telegram:", e);
  } else {
    console.error("Невідома помилка:", e);
  }
});
```

### Вебхуки

Якщо ви запускаєте свого бота через вебхуки, grammY передасть помилку фреймворку, який ви використовуєте: наприклад, `express`.
Ви повинні обробляти помилки відповідно до конвенцій цього фреймворку.

## Обʼєкт `BotError`

Об’єкт `BotError` об’єднує викинуту помилку з відповідним [об’єктом контексту](./context.md), який спричинив викид помилки.
Це працює наступним чином.

Яка б помилка не сталася під час обробки оновлення, grammY перехопить викинуту помилку за вас.
Часто буває корисно отримати доступ до об’єкта контексту, який спричинив помилку.

grammY жодним чином не торкається викликаної помилки, а натомість загортає її в екземпляр `BotError`.
Враховуючи, що отриманий об’єкт має назву `err`, ви можете отримати доступ до оригінальної помилки через `err.error`.
Ви можете отримати доступ до відповідного об’єкта контексту через `err.ctx`.

Ознайомтеся з класом `BotError` у [довідці API grammY](https://deno.land/x/grammy/mod.ts?s=BotError).

## Обʼєкт `GrammyError`

Якщо виклик методу API, як-от `sendMessage`, не вдається, grammY викине `GrammyError`.
Зауважте, що екземпляри `GrammyError` також будуть загорнуті в `BotError`, якщо вони створені в middleware.

Викинута `GrammyError` означає, що відповідний запит API не виконано.
Помилка надає доступ до коду та опису помилки, яку повертає серверна частина Telegram.

Ознайомтеся з класом `GrammyError` у [довідці API grammY](https://deno.land/x/grammy/mod.ts?s=GrammyError).

## Обʼєкт `HttpError`

Помилка HttpError викидається, якщо не вдається виконати мережевий запит.
Це означає, що grammY не зміг зв’язатися з сервером Bot API.
Об’єкт помилки містить інформацію про те, чому запит не вдалося виконати, яка доступна у властивості `error`.

Ви рідко будете побачити цю помилку, хіба що ваша мережева інфраструктура нестабільна або сервер Bot API вашого бота тимчасово не працює.

> Зауважте, що якщо зв’язатися з сервером Bot API можна, але він повертає `ok: false` для певного виклику методу, натомість буде викинута [`GrammyError`](#обʼєкт-grammyerror).

Ознайомтеся з класом `HttpError` у [довідці API grammY](https://deno.land/x/grammy/mod.ts?s=HttpError).

## Межі помилок

> Це розширена тема, яка здебільшого корисна для великих ботів.
> Якщо ви відносно новачок у grammY, просто пропустіть решту цього розділу.

Якщо ви розділите свою кодову базу на різні частини, _межі помилок_ дозволять вам встановити різні обробники помилок для різних частин ваших middleware.
Вони досягають цього, дозволяючи вам відокремлювати помилки в частині вашого middleware.
Іншими словами, якщо помилка виникає в спеціально захищеній частині middleware, вона не зможе вийти з цієї частини системи middleware.
Замість цього буде викликано спеціальний обробник помилок, а оточуюча частина middleware зробить вигляд, що завершується успішно.
Це функція системи middleware grammY, тому межі помилок не мають значення, чи використовуєте ви свого бота з вебхуками чи з тривалим опитуванням.

За бажанням ви можете дозволити виконанню middleware _відновитися_ у звичайному режимі після обробки помилки, продовжуючи поза межею помилки.
У цьому випадку відокремлений middleware не тільки діє так, ніби він був успішно завершений, але також передає потік керування наступному middleware, який було встановлено після межі помилки.
Отже, схоже, що middleware всередині межі помилки викликав `next`.

```ts
const bot = new Bot("");

bot.use(/* A */);
bot.use(/* B */);

const composer = new Composer();
composer.use(/* X */);
composer.use(/* Y */);
composer.use(/* Z */);
bot.errorBoundary(boundaryHandler /* , Q */).use(composer);

bot.use(/* C */);
bot.use(/* D */);

bot.catch(errorHandler);

function boundaryHandler(err: BotError, next: NextFunction) {
  console.error("Помилка в Q, X, Y або Z!", err);
  /*
   * Можемо викликати `next`, якщо хочемо запустити
   * middleware, позначений як C, у разі помилки:
   */
  // await next()
}

function errorHandler(err: BotError) {
  console.error("Помилка в A, B, C або D!", err);
}
```

У наведеному вище прикладі `boundaryHandler` буде викликано для:

1. Усіх middleware, які передаються до `bot.errorBoundary` після `boundaryHandler`, тобто `Q`.
2. Усіх middleware, які встановлено на згодом встановлений екземпляр composer: `X`, `Y` і `Z`.

> Щодо 2-го пункту, ви можете перейти до [розширеного пояснення](../advanced/middleware.md) middleware, щоб дізнатися, як chaining працює у grammY.

Ви також можете застосувати межу помилки до composer без виклику `bot.errorBoundary`:

```ts
const composer = new Composer();

const protected = composer.errorBoundary(boundaryHandler);
protected.use(/* B */);

bot.use(composer);
bot.use(/* C */);

bot.catch(errorHandler);

function boundaryHandler(err: BotError, next: NextFunction) {
  console.error("Помилка в B!", err);
}

function errorHandler(err: BotError) {
  console.error("Помилка в C!", err);
}
```

`boundaryHandler` з наведеного вище прикладу буде викликано для middleware, прив’язаного до `protected`.

Якщо ви дійсно хочете, щоб помилка перетнула межу, тобто передати її назовні, ви можете повторно викинути помилку у своєму обробнику помилок.
Помилка буде передана наступній навколишній межі.

У певному сенсі ви можете розглядати обробник помилок, встановлений через `bot.catch`, як крайню межу помилки.
